<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kontenübersicht – Meine Bank</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

  <style>
    body { font-family: Arial; margin:0; padding:0; }
    header { background:#00539C; color:white; text-align:center; padding:1em; }
    main { max-width:800px; margin:20px auto; padding:20px;
           border-radius:10px; background:white; box-shadow:0 2px 6px black; }
    .konto-info { display:flex; justify-content:space-between; margin-bottom:20px; }
    .saldo { font-size:1.5em; color:#00539C; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:10px; border-bottom:1px solid #ddd; }
    th { background:#f3f3f3; }
    .negativ{color:red;} .positiv{color:green;}
    button { padding:8px 15px; background:#00539C; color:white; border:0; border-radius:5px; cursor:pointer; }
    button:hover { background:#003f73; }
  </style>
</head>

<body>

<header>
  <h1>Meine Bank – Kontenübersicht</h1>
</header>

<main>
  <div class="konto-info">
    <div>
      <h2>Girokonto</h2>
      <p>IBAN: DE12 3456 7890 1234 5678 90</p>
    </div>
    <div class="saldo" id="saldoAnzeige">Lade...</div>
  </div>

<input 
  type="text" 
  id="searchInput" 
  placeholder="Suche in allen Spalten..."
  style="
    width: 90%;
    padding: 10px;
    margin: 15px 0;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 6px;
  "
>

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Beschreibung</th>
        <th>Betrag (€)</th>
        <th>Labels</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="umsatzTabelle"></tbody>
  </table>

  <button id="aktualisierenBtn">Umsätze aktualisieren</button>
</main>

<script>
let db;
let alleUmsaetze = [];
let temporaereLabels = {}; // Speichert temporäre Labels pro UmsatzID

// 1. Datenbank laden
async function ladeDatenbank() {
  try {
    const SQL = await initSqlJs({
      locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${f}`
    });

    const file = await fetch("db/Bank.db");
    const buf = await file.arrayBuffer();
    db = new SQL.Database(new Uint8Array(buf));

    ladeUmsaetze();
  } catch (error) {
    console.error("Fehler beim Laden der Datenbank:", error);
    document.getElementById("saldoAnzeige").textContent = "Fehler beim Laden";
  }
}

document.getElementById("aktualisierenBtn").onclick = ladeUmsaetze;

// 2. Labels zu einem Umsatz abrufen (inklusive temporäre Labels)
function ladeLabels(umsatzID) {
    let dbLabels = [];
    
    try {
        const stmt = db.prepare(`
            SELECT Labels.Name
            FROM Labels
            JOIN UmsatzLabels ON Labels.LabelID = UmsatzLabels.LabelID
            WHERE UmsatzLabels.UmsatzID = ?
        `);

        stmt.bind([umsatzID]);

        while (stmt.step()) {
            dbLabels.push(stmt.getAsObject().Name);
        }
        stmt.free();
    } catch (error) {
        console.error("Fehler beim Laden der Labels:", error);
    }

    // Temporäre Labels hinzufügen
    const tempLabels = temporaereLabels[umsatzID] || [];
    const alleLabels = [...dbLabels, ...tempLabels];
    
    return alleLabels.join(", ");
}

// 3. Umsätze laden
function ladeUmsaetze() {
  if (!db) {
    console.error("Datenbank nicht geladen");
    return;
  }

  alleUmsaetze = []; // Reset für Suche
  let saldo = 0;

  try {
    const stmt = db.prepare(`
      SELECT UmsatzID, Datum, Beschreibung, Betrag, SenderIBAN
      FROM Umsatz
      ORDER BY Datum DESC
    `);

    while (stmt.step()) {
      const row = stmt.getAsObject();
      const labels = ladeLabels(row.UmsatzID);

      alleUmsaetze.push({
        id: row.UmsatzID,
        datum: row.Datum,
        beschreibung: row.Beschreibung,
        betrag: parseFloat(row.Betrag),
        sender: row.SenderIBAN,
        labels: labels
      });

      saldo += parseFloat(row.Betrag);
    }
    stmt.free();

    // Nur einmal rendern, nachdem alle Daten geladen wurden
    renderUmsaetze(alleUmsaetze);

    document.getElementById("saldoAnzeige").textContent = saldo.toFixed(2) + " €";
    
  } catch (error) {
    console.error("Fehler beim Laden der Umsätze:", error);
  }
}

// 4. Detailseite
function zeigeDetails(umsatzID) {
  const url = new URL("details.html", window.location.href);
  url.searchParams.set("umsatzID", umsatzID);
  
  // Temporäre Labels als URL-Parameter übergeben
  const tempLabels = temporaereLabels[umsatzID] || [];
  if (tempLabels.length > 0) {
    url.searchParams.set("tempLabels", tempLabels.join(","));
  }
  
  window.location.href = url.toString();
}

// 5. Render-Funktion
function renderUmsaetze(liste) {
  const tabelle = document.getElementById("umsatzTabelle");
  tabelle.innerHTML = "";

  liste.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.datum}</td>
      <td>${row.beschreibung}</td>
      <td class="${row.betrag < 0 ? 'negativ' : 'positiv'}">${row.betrag.toFixed(2)}</td>
      <td>${row.labels}</td>
      <td>
        <button onclick="zeigeDetails(${row.id})">Details</button>
      </td>
    `;
    tabelle.appendChild(tr);
  });
}

// 6. Funktion zum Hinzufügen temporärer Labels (wird von Detailseite aufgerufen)
function addTemporaereLabels(umsatzID, neueLabels) {
  if (!temporaereLabels[umsatzID]) {
    temporaereLabels[umsatzID] = [];
  }
  
  neueLabels.forEach(label => {
    if (!temporaereLabels[umsatzID].includes(label)) {
      temporaereLabels[umsatzID].push(label);
    }
  });
  
  // Umsätze neu laden, um aktualisierte Labels anzuzeigen
  ladeUmsaetze();
}

// Starten
ladeDatenbank();

// Live-Suche aktivieren
document.getElementById("searchInput").addEventListener("input", function() {
    const query = this.value.toLowerCase();

    const gefiltert = alleUmsaetze.filter(row => 
      row.datum.toLowerCase().includes(query) ||
      row.beschreibung.toLowerCase().includes(query) ||
      row.betrag.toString().includes(query) ||
      row.sender.toLowerCase().includes(query) ||
      row.labels.toLowerCase().includes(query)
    );

    renderUmsaetze(gefiltert);
});

// Event Listener für Nachrichten von der Detailseite
window.addEventListener('storage', function(e) {
  if (e.key === 'labelUpdate') {
    const data = JSON.parse(e.newValue);
    addTemporaereLabels(data.umsatzID, data.labels);
  }
});

</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<footer style="background:#00539C; padding:20px; text-align:center;">
    <div style="font-size:24px;">
        <a href="https://www.instagram.com/spardabw/?hl=de" 
           target="blank" 
           style="margin:0 15px; color:white;">
            <i class="fab fa-instagram"></i>
        </a>
        <a href="https://www.linkedin.com/company/sparda-bank-baden-w%C3%BCrttemberg/?originalSubdomain=de" 
           target="blank" 
           style="margin:0 15px; color:white;">
            <i class="fab fa-linkedin"></i>
        </a>
        <a href="https://www.sparda-bw.de/?gad_source=1&gad_campaignid=6464835005&gbraid=0AAAAADmBbPMOUBEonlvbJ0cHll8zwKKWq&gclid=CjwKCAiA8vXIBhAtEiwAf3B-g5VRORivE5zEXNoSXQ13sY_1P0FDw8bV0kItMY3e2VLWOiK03XC1phoCBCEQAvD_BwE" 
           target="blank" 
           style="margin:0 15px; color:white;">
            <i class="fas fa-globe"></i>
        </a>
    </div>

    <p style="margin-top:10px; font-size:14px; color:white;">
        © 2025 Sparda Bank- Baden Württemberg
    </p>
</footer>

</body>
</html>